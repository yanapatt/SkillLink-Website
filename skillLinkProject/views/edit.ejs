<h1>Edit Post</h1>
<form action="/update/<%= post.name %>" method="POST" enctype="multipart/form-data" id="edit-post-form">
    <label>Name:</label>
    <input type="text" name="name" value="<%= post.name %>" disabled>

    <label>Description:</label>
    <textarea name="description" required><%= post.description %></textarea>

    <label>Current Image:</label>
    <% if (post.imageUrl) { %>
        <div id="image-container">
            <img src="<%= post.imageUrl %>" alt="Post Image" width="150">
            <button type="button" id="delete-image-btn" data-url="/delete-image/<%= post.name %>">
                Delete Image
            </button>
        </div>
        <% } else { %>
            <p id="no-image-text" style="display: none;">No image available</p>
            <% } %>
                <input type="file" name="image" accept="image/*" id="image-upload" <%=post.imageUrl ? 'disabled' : '' %>
                >
                <br><br>
                <button type="submit">Update Post</button>
</form>

<script>
    document.getElementById("delete-image-btn")?.addEventListener("click", function () {
        if (confirm("Are you sure you want to delete this image?")) {
            fetch(this.dataset.url, { method: "POST" })
                .then(response => {
                    if (response.ok) {
                        document.getElementById("image-container").remove();
                    } else {
                        alert("Error deleting image");
                    }
                })
                .catch(error => console.error("Error:", error));
        }
    });

    document.getElementById("image-upload")?.addEventListener("change", function () {
        const form = document.getElementById("edit-post-form");
        const formData = new FormData(form);

        if (this.files.length > 0) {
            fetch(form.action, {
                method: "POST",
                body: formData,
            })
                .then(response => response.json())
                .then(data => {
                    if (data.imageUrl) {
                        const imageContainer = document.getElementById("image-container");
                        if (imageContainer) {
                            const newImage = document.createElement("img");
                            newImage.src = data.imageUrl;
                            newImage.width = 150;
                            imageContainer.innerHTML = "";
                            imageContainer.appendChild(newImage);

                            const deleteButton = document.createElement("button");
                            deleteButton.textContent = "Delete Image";
                            deleteButton.type = "button";
                            deleteButton.id = "delete-image-btn";
                            deleteButton.dataset.url = `/delete-image/${data.name}`;
                            imageContainer.appendChild(deleteButton);

                            deleteButton.addEventListener("click", function () {
                                if (confirm("Are you sure you want to delete this image?")) {
                                    fetch(deleteButton.dataset.url, {
                                        method: "POST",
                                    })
                                        .then(response => {
                                            if (response.ok) {
                                                imageContainer.innerHTML = "No image available"; // ลบภาพจากหน้า
                                            } else {
                                                alert("Error deleting image");
                                            }
                                        })
                                        .catch(error => console.error("Error deleting image:", error));
                                }
                            });
                        }
                    } else {
                        alert("Error uploading image");
                    }
                })
                .catch(error => console.error("Error uploading image:", error));
        }
    });
</script>